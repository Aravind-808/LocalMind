<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local RAG Chat</title>
    
    <style>
        :root { --sidebar-bg: #f3f4f6; --main-bg: #ffffff; --primary: #2563eb; --text: #1f2937; --border: #e5e7eb; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; display: flex; height: 100vh; color: var(--text); overflow: hidden; }

        .sidebar { width: 260px; background: var(--sidebar-bg); display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        .main-content { flex: 1; display: flex; flex-direction: column; background: var(--main-bg); position: relative; }

        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .new-chat-btn { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 500; }
        .new-chat-btn:hover { background: #1d4ed8; }
        
        .history-list { flex: 1; overflow-y: auto; padding: 10px; list-style: none; margin: 0; }
        .history-item { padding: 10px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; color: #4b5563; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .history-item:hover { background: #e5e7eb; color: #000; }
        .history-item.active { background: #dbeafe; color: var(--primary); font-weight: 600; }
        
        .delete-btn { opacity: 0; border: none; background: transparent; color: #9ca3af; cursor: pointer; font-size: 1.2rem; line-height: 1; padding: 0 5px; }
        .history-item:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { color: #ef4444; }

        .settings-area { padding: 15px; border-top: 1px solid var(--border); font-size: 0.85rem; }

        .top-bar { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: white; z-index: 10; }
        .top-bar h2 { margin: 0; font-size: 1rem; font-weight: 600; }
        .action-btn { background: white; border: 1px solid var(--border); padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; color: #374151; }
        .action-btn:hover { background: #f9fafb; border-color: #9ca3af; }

        #chat-container { flex: 1; overflow-y: auto; padding: 20px 40px; scroll-behavior: smooth; }
        
        .message-row { display: flex; margin-bottom: 25px; gap: 15px; }
        .message-row.user { justify-content: flex-end; }
        .avatar { width: 30px; height: 30px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; flex-shrink: 0; }
        .bot-avatar { background: #10b981; color: white; }
        .user-avatar { background: #6366f1; color: white; }

        .message-bubble { max-width: 80%; line-height: 1.6; font-size: 0.95rem; }
        .user .message-bubble { background: #eff6ff; padding: 10px 15px; border-radius: 12px; border-bottom-right-radius: 2px; }
        .bot .message-bubble { background: transparent; padding: 0; width: 100%; }

        .bot-text p { margin-top: 0; }
        .bot-text code { background: #f3f4f6; padding: 2px 4px; border-radius: 4px; font-family: monospace; color: #d63384; }
        .bot-text pre { background: #1f2937; color: #f9fafb; padding: 15px; border-radius: 6px; overflow-x: auto; }
        .bot-text ul { padding-left: 20px; }

        /* Table Styling */
        .chat-table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 0.9rem; background: white; border: 1px solid #e5e7eb; }
        .chat-table th, .chat-table td { border: 1px solid #e5e7eb; padding: 8px 12px; text-align: left; }
        .chat-table th { background-color: #f3f4f6; font-weight: 600; color: #1f2937; }
        .chat-table tr:nth-child(even) { background-color: #f9fafb; }
        .table-wrapper { overflow-x: auto; border-radius: 6px; border: 1px solid #e5e7eb; }

        .sources-section { margin-top: 10px; font-size: 0.8rem; color: #6b7280; border-top: 1px solid #e5e7eb; padding-top: 8px; }
        .source-tag { display: inline-block; background: #e5e7eb; padding: 2px 6px; border-radius: 4px; margin-right: 5px; margin-bottom: 5px; font-weight: 500; }

        .input-area { padding: 20px; background: white; border-top: 1px solid var(--border); display: flex; justify-content: center; }
        .input-wrapper { width: 100%; max-width: 800px; position: relative; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 12px 15px; border: 1px solid var(--border); border-radius: 8px; outline: none; font-size: 1rem; }
        input[type="text"]:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); }
        .send-btn { background: var(--primary); color: white; border: none; padding: 0 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .send-btn:disabled { background: #93c5fd; cursor: not-allowed; }

        #uploadModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .close-modal { cursor: pointer; font-size: 1.5rem; line-height: 1; }
        
        @media print {
            .sidebar, .input-area, .top-bar .action-btn, #uploadModal { display: none !important; }
            .top-bar { border: none; }
            .main-content { position: static; height: auto; overflow: visible; display: block; }
            #chat-container { overflow: visible; padding: 0; height: auto; }
            body { overflow: visible; height: auto; background: white; }
            .message-row { break-inside: avoid; page-break-inside: avoid; }
        }
        
        .cursor { display: inline-block; width: 6px; height: 16px; background: #333; animation: blink 1s infinite; vertical-align: middle; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    </style>
</head>
<body>

<aside class="sidebar">
    <div class="sidebar-header">
        <button class="new-chat-btn" onclick="createNewChat()"><span>+</span> New Chat</button>
    </div>
    <ul class="history-list" id="historyList"></ul>
    <div class="settings-area">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <span>üìö Chat Index:</span>
            <span id="indexStatus" style="font-weight:600;">Checking...</span>
        </div>
        <button class="action-btn" style="width:100%" onclick="openUploadModal()">Manage Docs</button>
    </div>
</aside>

<main class="main-content">
    <div class="top-bar">
        <h2 id="currentChatTitle">New Chat</h2>
        <button class="action-btn" onclick="window.print()">Print Conversation</button>
    </div>
    <div id="chat-container">
        <div style="text-align:center; color:#9ca3af; margin-top:50px;" id="emptyState">
            <p>Select a document and ask a question to begin.</p>
        </div>
    </div>
    <div class="input-area">
        <div class="input-wrapper">
            <input type="text" id="userInput" placeholder="Ask about your documents..." onkeypress="handleEnter(event)">
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
        </div>
    </div>
</main>

<div id="uploadModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üìÑ Document Ingestion</h3>
            <span class="close-modal" onclick="closeUploadModal()">&times;</span>
        </div>
        <div style="margin-bottom:15px;"><input type="file" id="fileInput" multiple accept=".pdf,.png,.jpg,.jpeg"></div>
        <div style="margin-bottom:15px; font-size:0.9rem;">
            <label><input type="radio" name="ingestMode" value="append" checked> Append</label>
            <label style="margin-left:15px;"><input type="radio" name="ingestMode" value="reset"> Overwrite</label>
        </div>
        <button class="new-chat-btn" id="doUploadBtn" onclick="uploadFiles()">Process Files</button>
        <p id="uploadStatus" style="margin-top:10px; font-size:0.85rem; color:#6b7280;"></p>
        <hr>
        <button class="action-btn" style="color:red; border-color:#fee2e2; width:100%" onclick="clearDB()">üóëÔ∏è Clear Database</button>
    </div>
</div>

<script>
    const API_URL = "http://127.0.0.1:8000";
    let currentSessionId = null;

    window.onload = async () => {
        try {
            await loadHistoryList();
            await createNewChat();
        } catch(e) { console.error("Initialization Failed:", e); }
    };

    function toggleEmptyState(show) {
        const el = document.getElementById('emptyState');
        if (el) el.style.display = show ? 'block' : 'none';
    }

    async function loadHistoryList() {
        try {
            const res = await fetch(`${API_URL}/history/list`);
            if(!res.ok) throw new Error("Backend error");
            const sessions = await res.json();
            const list = document.getElementById('historyList');
            list.innerHTML = "";
            sessions.forEach(sess => {
                const li = document.createElement('li');
                li.className = `history-item ${sess.id === currentSessionId ? 'active' : ''}`;
                li.onclick = function() { loadChat(sess.id); };
                li.innerHTML = `
                    <span style="overflow:hidden; text-overflow:ellipsis;">${sess.title}</span>
                    <button class="delete-btn" onclick="deleteChat(event, '${sess.id}')">&times;</button>
                `;
                list.appendChild(li);
            });
        } catch(e) { console.error(e); }
    }

    async function createNewChat() {
        try {
            const res = await fetch(`${API_URL}/chat/new`, { method: "POST" });
            const data = await res.json();
            currentSessionId = data.session_id;
            document.getElementById('chat-container').innerHTML = '';
            
            const container = document.getElementById('chat-container');
            container.innerHTML = `
                <div style="text-align:center; color:#9ca3af; margin-top:50px;" id="emptyState">
                    <p>Select a document and ask a question to begin.</p>
                </div>`;

            document.getElementById('currentChatTitle').innerText = "New Chat";
            toggleEmptyState(true);
            checkIndexStatus(); 
            loadHistoryList();
        } catch(e) { console.error(e); }
    }

    async function loadChat(sessId) {
        currentSessionId = sessId;
        const res = await fetch(`${API_URL}/history/${sessId}`);
        const data = await res.json();
        
        document.getElementById('currentChatTitle').innerText = data.title || "Untitled";
        const container = document.getElementById('chat-container');
        container.innerHTML = "";
        
        container.innerHTML += `
            <div style="text-align:center; color:#9ca3af; margin-top:50px; display:none;" id="emptyState">
                <p>Select a document and ask a question to begin.</p>
            </div>`;

        if (!data.messages || data.messages.length === 0) {
             toggleEmptyState(true);
        } else {
             toggleEmptyState(false);
             data.messages.forEach(msg => renderMessage(msg.role, msg.content, msg.sources));
        }
        checkIndexStatus(); // Check for THIS chat
        loadHistoryList(); 
    }

    async function deleteChat(e, sessId) {
        e.stopPropagation();
        if(!confirm("Delete this chat and its documents?")) return;
        await fetch(`${API_URL}/history/${sessId}`, { method: "DELETE" });
        if(currentSessionId === sessId) createNewChat();
        else loadHistoryList();
    }

    function renderMessage(role, text, sources=null) {
        toggleEmptyState(false);
        const container = document.getElementById('chat-container');
        const isBot = role === 'bot';
        const div = document.createElement('div');
        div.className = `message-row ${role}`;
        
        let safeText = text || "";
        let contentHtml = isBot ? simpleMarkdown(safeText) : safeText;
        
        if (sources && sources.length > 0) {
            const badges = sources.map(s => `<span class="source-tag">${s}</span>`).join("");
            contentHtml += `<div class="sources-section">Sources: ${badges}</div>`;
        }

        div.innerHTML = `
            ${isBot ? '<div class="avatar bot-avatar">AI</div>' : ''}
            <div class="message-bubble">
                <div class="${isBot ? 'bot-text' : ''}">${contentHtml}</div>
            </div>
            ${!isBot ? '<div class="avatar user-avatar">U</div>' : ''}
        `;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    async function sendMessage() {
        const input = document.getElementById('userInput');
        const question = input.value.trim();
        if (!question) return;

        renderMessage('user', question);
        input.value = "";

        const container = document.getElementById('chat-container');
        const botRow = document.createElement('div');
        botRow.className = "message-row bot";
        botRow.innerHTML = `
            <div class="avatar bot-avatar">AI</div>
            <div class="message-bubble">
                <div class="bot-text"><span class="cursor"></span></div>
            </div>
        `;
        container.appendChild(botRow);
        const textDiv = botRow.querySelector('.bot-text');
        
        const btn = document.getElementById('sendBtn');
        btn.disabled = true;

        let fullText = "";
        let sourcesText = "";
        let collectingSources = false;

        try {
            const res = await fetch(`${API_URL}/ask`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: question, session_id: currentSessionId })
            });

            if (!res.ok) throw new Error("Backend Error");

            const reader = res.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });

                if (chunk.includes("__SOURCES__:")) {
                    const parts = chunk.split("__SOURCES__:");
                    fullText += parts[0];
                    collectingSources = true;
                    sourcesText += parts[1];
                } else if (collectingSources) {
                    sourcesText += chunk;
                } else {
                    fullText += chunk;
                }
                
                textDiv.innerHTML = simpleMarkdown(fullText) + '<span class="cursor"></span>';
                container.scrollTop = container.scrollHeight;
            }

            let finalHtml = simpleMarkdown(fullText);
            if (sourcesText) {
                try {
                    const srcData = JSON.parse(sourcesText);
                    const badges = srcData.map(s => `<span class="source-tag">${s}</span>`).join("");
                    finalHtml += `<div class="sources-section">Sources: ${badges}</div>`;
                } catch(e) {}
            }
            textDiv.innerHTML = finalHtml;
            loadHistoryList(); 

        } catch (e) {
            console.error(e);
            textDiv.innerHTML += `<div style="color:red">Error: ${e.message}</div>`;
        } finally {
            btn.disabled = false;
        }
    }

    function handleEnter(e) { if(e.key === "Enter") sendMessage(); }

    function simpleMarkdown(text) {
        if (!text) return "";
        let output = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

        const codeBlocks = [];
        output = output.replace(/```([\s\S]*?)```/g, (match, code) => {
            codeBlocks.push(`<pre><code>${code}</code></pre>`);
            return `__CODEBLOCK_${codeBlocks.length - 1}__`;
        });

        const lines = output.split('\n');
        let finalHtml = "";
        let tableBuffer = [];
        let inList = false;

        function flushTable() {
            if (tableBuffer.length === 0) return;
            const sepIndex = tableBuffer.findIndex(row => /^[\|\s\-:]+$/.test(row) && row.includes('-'));
            
            if (sepIndex === -1 && tableBuffer.length < 2) {
                finalHtml += tableBuffer.join('<br>') + '<br>';
            } else {
                finalHtml += '<div class="table-wrapper"><table class="chat-table">';
                tableBuffer.forEach((row, i) => {
                    if (i === sepIndex) return;
                    let cols = row.split('|').map(c => c.trim());
                    if (cols[0] === '') cols.shift();
                    if (cols[cols.length-1] === '') cols.pop();
                    finalHtml += '<tr>';
                    const isHeader = sepIndex > -1 && i < sepIndex;
                    const tag = isHeader ? 'th' : 'td';
                    cols.forEach(col => { finalHtml += `<${tag}>${applyInlineFormatting(col)}</${tag}>`; });
                    finalHtml += '</tr>';
                });
                finalHtml += '</table></div>';
            }
            tableBuffer = [];
        }

        lines.forEach(line => {
            const trimmed = line.trim();
            if (trimmed.startsWith('|') && (trimmed.endsWith('|') || trimmed.split('|').length > 2)) {
                if (inList) { finalHtml += "</ul>"; inList = false; }
                tableBuffer.push(trimmed);
            } else if (trimmed.match(/^\s*-\s+/)) {
                flushTable();
                if (!inList) { finalHtml += "<ul>"; inList = true; }
                finalHtml += `<li>${applyInlineFormatting(trimmed.replace(/^\s*-\s+/, ''))}</li>`;
            } else {
                flushTable();
                if (inList) { finalHtml += "</ul>"; inList = false; }
                finalHtml += applyInlineFormatting(line) + '<br>';
            }
        });
        flushTable();
        if (inList) finalHtml += "</ul>";
        output = finalHtml.replace(/__CODEBLOCK_(\d+)__/g, (match, index) => codeBlocks[index]);
        return output;
    }

    function applyInlineFormatting(text) {
        return text
            .replace(/`([^`]+)`/g, '<code>$1</code>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>');
    }

    function openUploadModal() { document.getElementById('uploadModal').style.display = 'flex'; }
    function closeUploadModal() { document.getElementById('uploadModal').style.display = 'none'; }
    
    async function checkIndexStatus() {
        if (!currentSessionId) return;
        try {
            // Check status for THIS session only
            const res = await fetch(`${API_URL}/system/status/${currentSessionId}`);
            const data = await res.json();
            const statusSpan = document.getElementById('indexStatus');
            statusSpan.innerText = data.index_exists ? "Active" : "Empty";
            statusSpan.style.color = data.index_exists ? "green" : "gray";
        } catch(e) { console.error("Status check failed", e); }
    }

    async function uploadFiles() {
        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('uploadStatus');
        const btn = document.getElementById('doUploadBtn');
        const mode = document.querySelector('input[name="ingestMode"]:checked').value;

        if (!fileInput.files.length) return alert("Select files first");
        
        const formData = new FormData();
        for (let f of fileInput.files) formData.append("files", f);
        formData.append("action", mode);
        formData.append("session_id", currentSessionId); 

        btn.disabled = true; status.innerText = "Ingesting...";
        try {
            const res = await fetch(`${API_URL}/upload`, { method: "POST", body: formData });
            const data = await res.json();
            status.innerText = `Success: ${data.chunks} chunks added.`;
            checkIndexStatus();
        } catch(e) { status.innerText = "Error: " + e.message; }
        finally { btn.disabled = false; }
    }

    async function clearDB() {
        if(!confirm("Clear documents for this chat?")) return;
        await fetch(`${API_URL}/system/clear/${currentSessionId}`, { method: "POST" });
        alert("Cleared"); checkIndexStatus();
    }
</script>

</body>
</html>